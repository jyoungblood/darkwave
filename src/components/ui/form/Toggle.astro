---
// DW - Form toggle component using shadcn/ui Switch

import Label from "@/components/ui/form/Label.astro";
import { Switch } from "@/components/ui/shadcn/switch";

interface Props {
  label?: string;
  sublabel?: string | string[];
  popover?: boolean;
  popoverIcon?: string;
  name: string;
  required?: boolean;
  class?: string;
  checked?: boolean;
  disabled?: boolean;
  size?: "xs" | "sm" | "md" | "lg" | "xl";
  color?:
    | "primary"
    | "secondary"
    | "accent"
    | "info"
    | "success"
    | "warning"
    | "error";
  helperText?: string;
  outline?: boolean;
}

const {
  label,
  sublabel,
  popover,
  popoverIcon,
  name,
  required = false,
  class: customClass = "",
  checked = false,
  disabled = false,
  size = "md",
  color = "primary",
  helperText,
  outline = false,
} = Astro.props;

const defaultClass = "flex items-center gap-2.5";
const className = customClass ? `${defaultClass} ${customClass}` : defaultClass;
---

<div class={className}>
  <input
    type="hidden"
    name={name}
    value={checked ? "on" : "off"}
    id={`${name}-hidden`}
  />
  <Switch
    client:load
    id={name}
    required={required}
    defaultChecked={checked}
    disabled={disabled}
    data-toggle-name={name}
  />
  {label && <Label class="text-sm" text={label} for={name} subtext={sublabel} popover={popover !== undefined ? popover : !!sublabel} subtextInline={true} popoverIcon={popoverIcon} />}
</div>

<script define:vars={{ name, checked }}>
  // Sync Switch state with hidden input for form submission
  function syncToggleInput() {
    const switchElement = document.querySelector(`[data-toggle-name="${name}"]`);
    const hiddenInput = document.getElementById(`${name}-hidden`);
    if (!switchElement || !hiddenInput) return;

    // Watch for state changes using MutationObserver
    const observer = new MutationObserver(() => {
      const isChecked = switchElement.getAttribute('data-state') === 'checked';
      hiddenInput.value = isChecked ? 'on' : 'off';
    });

    observer.observe(switchElement, {
      attributes: true,
      attributeFilter: ['data-state']
    });

    // Set initial value
    const isChecked = switchElement.getAttribute('data-state') === 'checked';
    hiddenInput.value = isChecked ? 'on' : 'off';
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', syncToggleInput);
  } else {
    syncToggleInput();
  }
</script>

