---
// DW - Form input text component using shadcn/ui Input

import Label from "@/components/ui/form/Label.astro";
import { Input } from "@/components/ui/shadcn/input";

interface Props {
  label?: string;
  sublabel?: string | string[];
  popover?: boolean;
  popoverIcon?: string;
  name: string;
  required?: boolean;
  value?: string;
  placeholder?: string;
  class?: string;
  type?: "text" | "password" | "email" | "number" | "tel" | "url" | "search";
  validation?: {
    types?: string[]; // Simple string-based validation types
    rules?: Array<{
      type: string;
      min?: number;
      max?: number;
      pattern?: string;
      errorMessage?: string;
      options?: Record<string, any>;
      locale?: string;
      version?: string;
      countryCode?: string;
    }>;
    success?: boolean | { message: string };
    showSuccessUI?: boolean;
    unique?: {
      collection: string;
      field: string;
      errorMessage: string;
      exempt?: {
        [key: string]: string;
      };
    };
  };
  htmlAttributes?: Record<string, string>;
}

const {
  label,
  sublabel,
  popover,
  popoverIcon,
  name,
  required = false,
  value = "",
  placeholder = "",
  class: customClass = "",
  type,
  validation,
  htmlAttributes = {},
} = Astro.props;

// Determine input type
// Use explicit type prop if provided, otherwise infer from validation rules
const inputType = type
  ? type
  : validation?.rules?.find((rule) => rule.type === "number")
  ? "number"
  : "text";

// Only include validation attributes if validation is configured
// React doesn't set data attributes with empty strings, so we filter them out
let validationAttributes: Record<string, string> = {};
if (validation) {
  validationAttributes["data-validation-config"] = JSON.stringify(validation);
  validationAttributes["data-input-name"] = name;
  
  if (validation.types && validation.types.length > 0) {
    validationAttributes["data-validation-types"] = JSON.stringify(validation.types);
  }
  
  if (validation.rules && validation.rules.length > 0) {
    validationAttributes["data-validation-rules"] = JSON.stringify(validation.rules);
  }
  
  if (validation.unique) {
    validationAttributes["data-unique-check"] = JSON.stringify(validation.unique);
  }
  
  if (validation.success) {
    validationAttributes["data-success"] = typeof validation.success === "object"
      ? JSON.stringify(validation.success)
      : String(validation.success);
  }
}
---

<div class="flex flex-col" id={`input-container-${name}`} data-input-name={name} data-has-validation={validation ? "true" : "false"}>
  {label && <Label text={label} class="mb-2" for={`input-${name}`} subtext={sublabel} popover={popover} popoverIcon={popoverIcon} />}
  <Input
    client:load
    type={inputType}
    id={`input-${name}`}
    name={name}
    required={required}
    className={customClass}
    defaultValue={value}
    placeholder={placeholder}
    autoComplete="off"
    {...validationAttributes}
    {...htmlAttributes}
  />
  <span class="validation-feedback text-sm mt-1 hidden"></span>
</div>

<script>
  import { validateOnBlur } from "@/components/ui/scripts/validate-input.js";
  // Ensure validateOnBlur is available globally
  // @ts-ignore
  window.validateOnBlur = validateOnBlur;
  
  // Attach blur listeners to all inputs with validation
  function attachBlurListeners() {
    const containers = document.querySelectorAll('[data-has-validation="true"]');
    containers.forEach((container) => {
      const inputName = container.getAttribute('data-input-name');
      if (!inputName) return;
      
      const inputId = `input-${inputName}`;
      const input = document.getElementById(inputId);
      if (!input) {
        return;
      }
      
      // Check if listener is already attached
      if (input.dataset.blurListenerAttached === "true") {
        return;
      }
      
      // Mark as attached to avoid duplicates
      input.dataset.blurListenerAttached = "true";
      
      // Attach the blur event listener directly
      input.addEventListener("blur", async (e) => {
        if ((window as any).validateOnBlur) {
          try {
            await (window as any).validateOnBlur(e);
          } catch (error) {
            console.error("[InputText] Validation error:", error);
          }
        }
      }, { capture: false, passive: false });
    });
  }
  
  // Try to attach immediately, and also after DOM ready and after a delay for React hydration
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", attachBlurListeners);
  } else {
    attachBlurListeners();
  }
  
  // Also try after React hydration (usually happens after a short delay)
  setTimeout(attachBlurListeners, 500);
  setTimeout(attachBlurListeners, 1000);
</script>
