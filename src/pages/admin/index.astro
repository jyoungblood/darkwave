---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { formatDate } from "@/lib/dw/helpers";
import { db } from "@/lib/db";
import Card from "@/components/ui/Card/Card.astro";
import CardHeader from "@/components/ui/Card/CardHeader.astro";
import CardTitle from "@/components/ui/Card/CardTitle.astro";
import CardContent from "@/components/ui/Card/CardContent.astro";
import CardFooter from "@/components/ui/Card/CardFooter.astro";
import ButtonLink from "@/components/ui/ButtonLink.astro";

let links;
let users;

try {
  // Fetch all data in parallel
  const [linksResult, usersResult] = await Promise.all([
    (async () => {
      return await db
        .selectFrom("links")
        .selectAll()
        .where("deleted_at", "is", null)
        .execute();
    })(),
    (async () => {
      return await db.selectFrom("user").selectAll().execute();
    })(),
  ]);

  // Assign the results
  links = linksResult;
  users = usersResult;
} catch (error) {
  console.error("Error fetching data:", error);
}
---

<AdminLayout>
  <div class="w-full">
    <h2 class="text-2xl font-bold mb-6">&nbsp;</h2>
    <div class="grid grid-cols-3 gap-6">
      <Card class="bg-white/90">
        <CardHeader>
          <div class="flex items-center justify-between gap-2">
            <div>
              <CardTitle>Links</CardTitle>
            </div>
            <div>
              <ButtonLink
                variant="outline"
                size="xs"
                href="/admin/links"
                text="Manage Links"
              />
            </div>
          </div>
        </CardHeader>
        <CardContent>
          <div class="flex items-start justify-between gap-2 mb-1">
            <div class="text-7xl font-bold">{links ? links.length : 0}</div>
            <div class="text-sm text-muted-foreground">
              Last updated: {
                links?.[0]?.updated_at
                  ? formatDate(links[0].updated_at.toString())
                  : "N/A"
              }
            </div>
          </div>
        </CardContent>
      </Card>

      <Card class="bg-white/90">
        <CardHeader>
          <div class="flex items-center justify-between gap-2">
            <div>
              <CardTitle>Users</CardTitle>
            </div>
            <div>
              <ButtonLink variant="outline" size="xs" href="/admin/users" text="Manage Users" />
            </div>
          </div>
        </CardHeader>
        <CardContent>
          <div class="flex items-start justify-between gap-2 mb-1">
            <div class="text-7xl font-bold">{users ? users.length : 0}</div>
            <div class="text-sm text-muted-foreground">
              Last updated: {
                users?.[0]?.updatedAt
                  ? formatDate(users[0].updatedAt.toString())
                  : "N/A"
              }
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  </div>
</AdminLayout>
