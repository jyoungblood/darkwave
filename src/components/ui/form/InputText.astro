---
// DW - Form input text component using shadcn/ui Input

import Label from "@/components/ui/form/Label.astro";
import { Input } from "@/components/ui/shadcn/input";

interface Props {
  label?: string;
  sublabel?: string | string[];
  popover?: boolean;
  popoverIcon?: string;
  name: string;
  required?: boolean;
  value?: string;
  placeholder?: string;
  class?: string;
  type?: "text" | "password" | "email" | "number" | "tel" | "url" | "search";
  validation?: {
    types?: string[]; // Simple string-based validation types
    rules?: Array<{
      type: string;
      min?: number;
      max?: number;
      pattern?: string;
      errorMessage?: string;
      options?: Record<string, any>;
      locale?: string;
      version?: string;
      countryCode?: string;
    }>;
    success?: boolean | { message: string };
    showSuccessUI?: boolean;
    unique?: {
      collection: string;
      field: string;
      errorMessage: string;
      exempt?: {
        [key: string]: string;
      };
    };
  };
  htmlAttributes?: Record<string, string>;
}

const {
  label,
  sublabel,
  popover,
  popoverIcon,
  name,
  required = false,
  value = "",
  placeholder = "",
  class: customClass = "",
  type,
  validation,
  htmlAttributes = {},
} = Astro.props;

// Determine input type
// Use explicit type prop if provided, otherwise infer from validation rules
const inputType = type
  ? type
  : validation?.rules?.find((rule) => rule.type === "number")
  ? "number"
  : "text";

// Only include validation attributes if validation is configured
const validationAttributes = validation
  ? {
      "data-validation-types": validation.types
        ? JSON.stringify(validation.types)
        : "",
      "data-validation-rules": validation.rules
        ? JSON.stringify(validation.rules)
        : "",
      "data-unique-check": validation.unique
        ? JSON.stringify(validation.unique)
        : "",
      "data-success":
        typeof validation.success === "object"
          ? JSON.stringify(validation.success)
          : validation.success,
      "data-validation-config": JSON.stringify(validation),
      "data-input-name": name,
    }
  : {};
---

<div class="flex flex-col" id={`input-container-${name}`}>
  {label && <Label text={label} class="mb-2" for={`input-${name}`} subtext={sublabel} popover={popover} popoverIcon={popoverIcon} />}
  <Input
    client:load
    type={inputType}
    id={`input-${name}`}
    name={name}
    required={required}
    className={customClass}
    defaultValue={value}
    placeholder={placeholder}
    autoComplete="off"
    onBlur={validation ? (e) => {
      // Pass React synthetic event - validation function uses event.target which React provides
      if ((window as any).validateOnBlur) {
        (window as any).validateOnBlur(e);
      }
    } : undefined}
    {...validationAttributes}
    {...htmlAttributes}
  />
  <span class="validation-feedback text-sm mt-1 hidden"></span>
</div>

<script>
  import { validateOnBlur } from "@/components/ui/scripts/validate-input.js";
  // @ts-ignore
  window.validateOnBlur = validateOnBlur;
</script>
