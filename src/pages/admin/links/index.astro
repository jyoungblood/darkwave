---
import AdminLayout from "@/layouts/AdminLayout.astro";
import TableDatalist from "@/components/ui/admin/TableDatalist.astro";
import {
  formatDate,
  getPaginationParams,
  renderIconButtonLink,
} from "@/lib/dw/helpers";
import { db } from "@/lib/db";
import Breadcrumb from "@/components/ui/Breadcrumb.astro";

let link;
let totalLinks = 0;

const keyword = Astro.url.searchParams.get("keyword");
const { currentPage, perPage, offset } = getPaginationParams(Astro.url, 50);

try {
  let baseQuery = db.selectFrom("links").where("deleted_at", "is", null);

  if (keyword && keyword.trim()) {
    const kw = `%${keyword.trim()}%`;
    baseQuery = baseQuery.where((eb) =>
      eb.or([eb("title", "like", kw), eb("uuid", "like", kw)])
    );
  }

  const [linksResult, countResult] = await Promise.all([
    baseQuery
      .selectAll()
      .orderBy("created_at")
      .limit(perPage)
      .offset(offset)
      .execute(),
    baseQuery
      .select(({ fn }) => [fn.countAll<number>().as("total")])
      .executeTakeFirst(),
  ]);

  link = linksResult;
  totalLinks = Number(countResult?.total || 0);
} catch (error) {
  console.error("Error fetching link:", error);
}
---

<AdminLayout title="All Links">
  <div class="w-full">
    <Breadcrumb
      items={[
        {
          href: "/admin",
          label: "Dashboard",
        },
        {
          href: "",
          label: "Links",
        },
      ]}
    />
    <TableDatalist
      data={link ?? []}
      columns={[
        {
          header: "Title",
          sortable: true,
          cell: {
            content: (link: any) =>
              `<a href="/admin/links/edit?uuid=${link.uuid}">${link.title}</a>`,
          },
        },
        {
          header: "Created At",
          // align: "center",
          sortable: true,
          accessorKey: "created_at",
          cell: {
            content: (link: any) => formatDate(link.created_at),
          },
        },
        {
          header: "Updated At",
          // align: "center",
          sortable: true,
          accessorKey: "updated_at",
          cell: {
            content: (link: any) =>
              link.updated_at ? formatDate(link.updated_at) : "",
          },
        },
        {
          header: "",
          align: "right",
          cell: {
            content: (link: any) =>
              `<span class="inline-flex gap-4">` +
              renderIconButtonLink({
                href: `/admin/links/edit?uuid=${link.uuid}`,
                icon: "icon-[tabler--pencil]",
                ariaLabel: "Edit",
                dataPrefetch: true,
              }) +
              renderIconButtonLink({
                href: `/links/${link.uuid}`,
                icon: "icon-[tabler--external-link]",
                ariaLabel: "View",
                target: "_blank",
                dataPrefetch: true,
              }) +
              `</span>`,
          },
        },
      ]}
      search={{
        placeholder: "Search links...",
      }}
      pagination={{
        currentPage,
        totalItems: totalLinks,
        perPage,
      }}
      buttonLinks={[
        {
          href: "/links",
          text: "Public Links",
        },
        {
          href: "/admin/links/new",
          text: "New Link",
        },
      ]}
    />
  </div>
</AdminLayout>
