---
// DW - Auth - Verify email form

import Layout from "@/layouts/Layout.astro";
import { auth } from "@/lib/auth/better";
import { Alert, AlertTitle, AlertDescription } from "@/components/ui/shadcn/alert";
import { AlertCircleIcon, CheckCircle2Icon } from "lucide-react";
import ButtonLink from "@/components/ui/ButtonLink.astro";

const { url } = Astro;

// Get verification token and status parameters
const token = url.searchParams.get("token");
const success = url.searchParams.get("success");
const errorMessage = url.searchParams.get("error");

let error = null;
let verified = false;

// Process verification if we have a token
if (token) {
  try {
    // Call Better Auth's API to verify the email
    const result = await auth.api.verifyEmail({
      query: { token }
    });
    
    verified = true;
  } catch (verificationError: any) {
    error = verificationError.message || "Failed to verify email";
  }
} else if (success) {
  // If we got redirected here with a success parameter, show success
  verified = true;
} else if (errorMessage) {
  // If we got redirected here with an error parameter, show error
  error = errorMessage;
} else {
  error = "Missing verification token";
}
---

<Layout title="Email Verification">
  <div class="flex flex-col items-center justify-center flex-1 p-4">
    <div class="w-full max-w-sm">
      {
        error ? (
          <Alert variant="destructive" client:load>
            <div class="flex items-start gap-3">
              <AlertCircleIcon client:load className="size-5 flex-shrink-0" />
              <div class="flex flex-col">
                <AlertTitle client:load className="text-lg font-semibold leading-none mb-2">Verification Failed</AlertTitle>
                <AlertDescription client:load>
                  {error}
                </AlertDescription>
              </div>
            </div>
          </Alert>
        ) : (
          <Alert client:load>
            <div class="flex items-start gap-3">
              <CheckCircle2Icon client:load className="size-5 text-green-600 flex-shrink-0" />
              <div class="flex flex-col">
                <AlertTitle client:load className="text-lg font-semibold leading-none mb-2">Email Confirmed</AlertTitle>
                <AlertDescription client:load>
                  <div class="mb-3">Your email has been successfully verified.</div>
                  <ButtonLink
                    href="/login"
                    variant="outline"
                    size="xs"
                    text="Log in to your account"
                  />
                </AlertDescription>
              </div>
            </div>            
          </Alert>
        )
      }
    </div>
  </div>
</Layout> 