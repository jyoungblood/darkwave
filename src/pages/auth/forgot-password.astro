---
// DW - Auth - Forgot password form

import Layout from "@/layouts/Layout.astro";
import { ensureCsrfToken } from "@/lib/csrf";
import InputText from "@/components/ui/form/InputText.astro";
import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from "@/components/ui/shadcn/card";
import { Button } from "@/components/ui/shadcn/button";
import ButtonLink from "@/components/ui/ButtonLink.astro";
import { Alert, AlertTitle, AlertDescription } from "@/components/ui/shadcn/alert";
import { AlertCircleIcon, CheckCircle2Icon } from "lucide-react";

ensureCsrfToken(Astro.cookies);

const { url } = Astro;

const error = url.searchParams.get("error");
---

<script>
  import { validateOnBlur } from "@/components/ui/scripts/validate-input.js";
  // @ts-ignore
  window.validateOnBlur = validateOnBlur;
</script>

<Layout title="Forgot Password">
  <div class="flex flex-col items-center justify-center flex-1 p-4">
    {
      error && (
        <Alert variant="destructive" client:load className="mb-6 w-full max-w-sm">
          <div class="flex items-start gap-3">
            <AlertCircleIcon client:load className="size-5 flex-shrink-0" />
            <div class="flex flex-col">
              <AlertTitle client:load className="text-lg font-semibold leading-none mb-2">Unable to process your request</AlertTitle>
              <AlertDescription client:load>
                {decodeURIComponent(error).charAt(0).toUpperCase() +
                  decodeURIComponent(error).slice(1)}
              </AlertDescription>
            </div>
          </div>
        </Alert>
      )
    }
    
    <div
      data-forgot-container
      class="w-full max-w-sm"
      role="region"
      aria-label="Password reset form"
    >
      <Card client:load className="mb-4">
        <form
          data-forgot-form
          aria-describedby="form-description"
        >
          <input
            type="hidden"
            name="csrf"
            value={Astro.cookies.get("csrf")?.value}
          />

          <CardHeader client:load>
            <div class="flex items-start justify-between gap-4">
              <div class="flex flex-col space-y-1.5">
                <CardTitle className="mb-2" client:load>Forgot password</CardTitle>
                <CardDescription className="text-xs" client:load id="form-description">
                  Request a link to reset your password
                </CardDescription>
              </div>
              <ButtonLink
                href="/login"
                variant="outline"
                size="xs"
                text="Log in"
              />
            </div>
          </CardHeader>

          <CardContent client:load>
            <div class="flex flex-col gap-6">
              <div class="grid gap-2">
                <InputText
                  label="Email"
                  name="email"
                  type="email"
                  required
                  placeholder="me@example.com"
                  validation={{
                    types: ["email"]
                  }}
                />
              </div>
            </div>
          </CardContent>

          <CardFooter client:load>
            <Button
              client:load
              type="submit"
              data-forgot-submit
              className="w-full"
              aria-busy="false"
            >
              <svg
                data-forgot-spinner
                class="hidden w-4 h-4 mr-2 animate-spin"
                viewBox="0 0 24 24"
                aria-hidden="true"
                role="presentation"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                  fill="none"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              <span data-forgot-text>Reset Password</span>
            </Button>
          </CardFooter>
        </form>
      </Card>
    </div>

    <div
      data-forgot-confirmation
      class="hidden w-full max-w-sm focus:outline-none"
      role="status"
      aria-live="polite"
    >
      <Alert client:load>
        <div class="flex items-start gap-3">
          <CheckCircle2Icon client:load className="size-5" />
          <div class="flex flex-col">
            <AlertTitle client:load className="text-lg font-semibold leading-none mb-2">Check your email</AlertTitle>
            <AlertDescription client:load>
              We've sent a password reset link to your email address. Please check
              your inbox and click the link to reset your password.
            </AlertDescription>
          </div>
        </div>
      </Alert>
    </div>
  </div>
</Layout>

<script>
  const form = document.querySelector("[data-forgot-form]") as HTMLFormElement;
  const submitButton = document.querySelector(
    "[data-forgot-submit]"
  ) as HTMLButtonElement;
  const buttonText = document.querySelector(
    "[data-forgot-text]"
  ) as HTMLSpanElement;
  const loadingSpinner = document.querySelector(
    "[data-forgot-spinner]"
  ) as HTMLElement;
  const forgotPasswordContainer = document.querySelector(
    "[data-forgot-container]"
  ) as HTMLDivElement;
  const confirmationContainer = document.querySelector(
    "[data-forgot-confirmation]"
  ) as HTMLDivElement;

  form.addEventListener("submit", async (event: SubmitEvent) => {
    event.preventDefault();

    // Set loading state
    submitButton.disabled = true;
    submitButton.setAttribute("aria-busy", "true");
    buttonText.textContent = "Sending reset link...";
    loadingSpinner.classList.remove("hidden");

    try {
      const response = await fetch("/api/auth/forgot-password", {
        method: "POST",
        body: new FormData(event.target as HTMLFormElement),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error);
      }

      // Show confirmation message
      forgotPasswordContainer.classList.add("hidden");
      confirmationContainer.classList.remove("hidden");

      // Move focus to confirmation message
      confirmationContainer.setAttribute("tabindex", "-1");
      confirmationContainer.focus();
    } catch (error: any) {
      console.error("Error:", error);
      window.location.href = `/auth/forgot-password?error=${encodeURIComponent(error.message)}`;
    } finally {
      // Reset loading state if there's an error
      submitButton.disabled = false;
      submitButton.setAttribute("aria-busy", "false");
    }
  });
</script>
