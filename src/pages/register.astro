---
// DW - Auth - Register form

import Layout from "@/layouts/Layout.astro";
import { ensureCsrfToken } from "@/lib/csrf";
import { auth } from "@/lib/auth/better";
import InputText from "@/components/ui/form/InputText.astro";
import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from "@/components/ui/shadcn/card";
import { Button } from "@/components/ui/shadcn/button";
import ButtonLink from "@/components/ui/ButtonLink.astro";

ensureCsrfToken(Astro.cookies);

// Check for available social providers
const hasSocialProviders =
  Object.keys(auth.options.socialProviders || {}).length > 0;
const hasGoogleProvider = auth.options.socialProviders?.google !== undefined;
---

<script>
  import { validateOnBlur, validateInput } from "@/components/ui/scripts/validate-input.js";
  // @ts-ignore
  window.validateOnBlur = validateOnBlur;
  // @ts-ignore
  window.validateInput = validateInput;
</script>

<Layout title="Register">
  <div class="flex flex-col items-center justify-center flex-1 p-4">
    <div
      data-register-container
      class="w-full max-w-sm"
      role="region"
      aria-label="Registration form"
    >
      <Card client:load className="mb-4">
        <form
          data-register-form
          aria-label="Email registration form"
        >
          <input
            type="hidden"
            name="csrf"
            value={Astro.cookies.get("csrf")?.value}
          />

          <CardHeader client:load>
            <div class="flex items-start justify-between gap-4">
              <div class="flex flex-col space-y-1.5">
                <CardTitle className="mb-2" client:load>Register</CardTitle>
                <CardDescription className="text-xs" client:load>
                  Enter your information to create your account
                </CardDescription>
              </div>
              <ButtonLink
                href="/login"
                variant="outline"
                size="xs"
                text="Log in"
              />
            </div>
          </CardHeader>

          <CardContent client:load>
            <div class="flex flex-col gap-6">
              <div class="grid gap-2">
                <InputText
                  label="First name"
                  name="first_name"
                  type="text"
                  required
                />
              </div>

              <div class="grid gap-2">
                <InputText
                  label="Last name"
                  name="last_name"
                  type="text"
                  required
                />
              </div>

              <div class="grid gap-2">
                <InputText
                  label="Email"
                  name="email"
                  type="email"
                  required
                  placeholder="me@example.com"
                  validation={{
                    types: ["email"],
                    unique: {
                      collection: "user",
                      field: "email",
                      errorMessage: "This email is already registered",
                    },
                  }}
                />
              </div>

              <div class="grid gap-2">
                <InputText
                  label="Password"
                  name="password"
                  type="password"
                  required
                  validation={{
                    rules: [{
                      type: "length",
                      min: 8,
                      errorMessage: "Password must be at least 8 characters"
                    }]
                  }}
                />
              </div>
            </div>
          </CardContent>

          <CardFooter client:load className="flex-col gap-2">
            <Button
              client:load
              type="submit"
              data-register-submit
              className="w-full"
              aria-busy="false"
            >
              <svg
                data-register-spinner
                class="hidden w-4 h-4 mr-2 animate-spin"
                viewBox="0 0 24 24"
                aria-hidden="true"
                role="presentation"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                  fill="none"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              <span data-register-text>Register</span>
            </Button>

            {
              hasGoogleProvider && (
                <form
                  action="/api/auth/register-oauth"
                  method="post"
                  class="w-full"
                  aria-label="Social login options"
                >
                  <input
                    type="hidden"
                    name="csrf"
                    value={Astro.cookies.get("csrf")?.value}
                  />
                  <Button
                    client:load
                    type="submit"
                    value="google"
                    name="provider"
                    variant="outline"
                    className="w-full"
                    aria-label="Continue with Google"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-auto"
                      preserveAspectRatio="xMidYMid"
                      viewBox="0 0 256 262"
                      aria-hidden="true"
                      role="presentation"
                    >
                      <path
                        fill="#4285F4"
                        d="M255.878 133.451c0-10.734-.871-18.567-2.756-26.69H130.55v48.448h71.947c-1.45 12.04-9.283 30.172-26.69 42.356l-.244 1.622 38.755 30.023 2.685.268c24.659-22.774 38.875-56.282 38.875-96.027"
                      />
                      <path
                        fill="#34A853"
                        d="M130.55 261.1c35.248 0 64.839-11.605 86.453-31.622l-41.196-31.913c-11.024 7.688-25.82 13.055-45.257 13.055-34.523 0-63.824-22.773-74.269-54.25l-1.531.13-40.298 31.187-.527 1.465C35.393 231.798 79.49 261.1 130.55 261.1"
                      />
                      <path
                        fill="#FBBC05"
                        d="M56.281 156.37c-2.756-8.123-4.351-16.827-4.351-25.82 0-8.994 1.595-17.697 4.206-25.82l-.073-1.73L15.26 71.312l-1.335.635C5.077 89.644 0 109.517 0 130.55s5.077 40.905 13.925 58.602l42.356-32.782"
                      />
                      <path
                        fill="#EB4335"
                        d="M130.55 50.479c24.514 0 41.05 10.589 50.479 19.438l36.844-35.974C195.245 12.91 165.798 0 130.55 0 79.49 0 35.393 29.301 13.925 71.947l42.211 32.783c10.59-31.477 39.891-54.251 74.414-54.251"
                      />
                    </svg>
                    Continue with Google
                  </Button>
                </form>
              )
            }
          </CardFooter>

          <input type="hidden" name="provider" value="email" />
        </form>
      </Card>

    </div>

    <div
      data-register-verify-container
      class="hidden w-full max-w-sm focus:outline-none"
      role="status"
      aria-live="polite"
    >
      <Card client:load>
        <CardHeader client:load>
          <CardTitle client:load>Verify your email</CardTitle>
        </CardHeader>
        <CardContent client:load>
          <CardDescription client:load>
            We've sent a verification email to your inbox. Please check your email
            and click the link to verify your account.
          </CardDescription>
        </CardContent>
      </Card>
    </div>
  </div>
</Layout>

<script>
  import { validateForm } from "@/components/ui/scripts/validate-form.js";
  import { validateInput } from "@/components/ui/scripts/validate-input.js";

  const form = document.querySelector(
    "[data-register-form]"
  ) as HTMLFormElement;
  const submitButton = document.querySelector(
    "[data-register-submit]"
  ) as HTMLButtonElement;
  const buttonText = document.querySelector(
    "[data-register-text]"
  ) as HTMLSpanElement;
  const loadingSpinner = document.querySelector(
    "[data-register-spinner]"
  ) as HTMLElement;
  const registerContainer = document.querySelector(
    "[data-register-container]"
  ) as HTMLDivElement;
  const verifyEmailContainer = document.querySelector(
    "[data-register-verify-container]"
  ) as HTMLDivElement;

  form.addEventListener("submit", async (event: SubmitEvent) => {
    event.preventDefault();

    // Validate all fields with validation config before form validation
    const fieldsWithValidation = form.querySelectorAll(
      "input[data-validation-config], textarea[data-validation-config], select[data-validation-config]"
    );
    for (const field of Array.from(fieldsWithValidation)) {
      await validateInput(field as HTMLInputElement);
    }

    // Run form validation (checks required fields and validation errors)
    if (!validateForm(form)) {
      // Reset loading state if validation failed
      submitButton.disabled = false;
      submitButton.setAttribute("aria-busy", "false");
      buttonText.textContent = "Register";
      loadingSpinner.classList.add("hidden");
      return;
    }

    // Set loading state
    submitButton.disabled = true;
    submitButton.setAttribute("aria-busy", "true");
    buttonText.textContent = "Registering...";
    loadingSpinner.classList.remove("hidden");

    try {
      const response = await fetch("/api/auth/register", {
        method: "POST",
        body: new FormData(event.target as HTMLFormElement),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "An unexpected error occurred");
      }

      // Always show verification message on success
      showVerificationMessage();
    } catch (error: any) {
      console.error("Error:", error);
      // Show error message on the page instead of redirecting
      // Create Alert-style error message structure matching login.astro pattern
      const errorAlert = document.createElement("div");
      errorAlert.className =
        "relative w-full rounded-lg border border-destructive/50 text-destructive dark:border-destructive p-3 mt-4";
      errorAlert.setAttribute("role", "alert");
      errorAlert.setAttribute("aria-live", "assertive");
      
      const flexContainer = document.createElement("div");
      flexContainer.className = "flex items-start gap-3";
      
      // Create AlertCircleIcon SVG (lucide-react icon structure)
      const iconSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      iconSvg.setAttribute("class", "size-5 flex-shrink-0");
      iconSvg.setAttribute("xmlns", "http://www.w3.org/2000/svg");
      iconSvg.setAttribute("width", "20");
      iconSvg.setAttribute("height", "20");
      iconSvg.setAttribute("viewBox", "0 0 24 24");
      iconSvg.setAttribute("fill", "none");
      iconSvg.setAttribute("stroke", "currentColor");
      iconSvg.setAttribute("stroke-width", "2");
      iconSvg.setAttribute("stroke-linecap", "round");
      iconSvg.setAttribute("stroke-linejoin", "round");
      
      const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circle.setAttribute("cx", "12");
      circle.setAttribute("cy", "12");
      circle.setAttribute("r", "10");
      
      const path1 = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path1.setAttribute("d", "m12 8 0 4");
      
      const path2 = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path2.setAttribute("d", "m12 16 .01 0");
      
      iconSvg.appendChild(circle);
      iconSvg.appendChild(path1);
      iconSvg.appendChild(path2);
      
      const contentContainer = document.createElement("div");
      contentContainer.className = "flex flex-col";
      
      const alertDescription = document.createElement("div");
      alertDescription.className = "text-sm leading-tight";
      alertDescription.textContent = error.message;
      
      contentContainer.appendChild(alertDescription);
      flexContainer.appendChild(iconSvg);
      flexContainer.appendChild(contentContainer);
      errorAlert.appendChild(flexContainer);

      // Insert error message after the form
      const form = document.querySelector("[data-register-form]");
      if (form) {
        form.parentNode?.insertBefore(errorAlert, form.nextSibling);
      }

      // Reset loading state
      submitButton.disabled = false;
      submitButton.setAttribute("aria-busy", "false");
      buttonText.textContent = "Register";
      loadingSpinner.classList.add("hidden");
    } finally {
      // Reset loading state if there's an error
      submitButton.disabled = false;
      submitButton.setAttribute("aria-busy", "false");
      buttonText.textContent = "Register";
      loadingSpinner.classList.add("hidden");
    }
  });

  function showVerificationMessage() {
    registerContainer.classList.add("hidden");
    verifyEmailContainer.classList.remove("hidden");
    // Move focus to verification container
    verifyEmailContainer.setAttribute("tabindex", "-1");
    verifyEmailContainer.focus();
  }
</script>
