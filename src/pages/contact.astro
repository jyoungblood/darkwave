---
import Layout from "@/layouts/Layout.astro";
import { ensureCsrfToken } from "@/lib/csrf";
import InputText from "@/components/ui/form/InputText.astro";
import Textarea from "@/components/ui/form/Textarea.astro";
import { CheckCircle2Icon } from "lucide-react";
import {
  Card,
  CardTitle,
  CardDescription,
  CardContent,
  CardFooter,
} from "@/components/ui/shadcn/card";
import { Button } from "@/components/ui/shadcn/button";

ensureCsrfToken(Astro.cookies);

const { url } = Astro;

const error = url.searchParams.get("error");
---

<script>
  import { validateOnBlur } from "@/components/ui/scripts/validate-input.js";
  // @ts-ignore
  window.validateOnBlur = validateOnBlur;
</script>

<Layout title="Contact Us">
  <div class="flex flex-col items-center justify-center flex-1 p-4">
    <div class="w-full max-w-lg" role="region" aria-label="Contact form">
      <h1 class="text-2xl font-bold mb-6 text-center" data-contact-title>
        Contact Us
      </h1>

      <form data-contact-form aria-label="Contact form">
        <Card client:load className="mb-4 pt-6">
          <input
            type="hidden"
            name="csrf"
            value={Astro.cookies.get("csrf")?.value}
          />

          <CardContent client:load>
            <div class="flex flex-col gap-6">
              <div class="grid gap-2">
                <InputText
                  label="Your Name"
                  name="name"
                  type="text"
                  value={Astro.locals.name}
                  required
                />
              </div>

              <div class="grid gap-2">
                <InputText
                  label="Your Email"
                  name="email"
                  type="email"
                  value={Astro.locals.email}
                  required
                  placeholder="me@example.com"
                  validation={{
                    types: ["email"],
                  }}
                />
              </div>

              <div class="grid gap-2">
                <InputText
                  label="Subject"
                  name="subject"
                  type="text"
                  required
                />
              </div>

              <div class="grid gap-2">
                <Textarea
                  label="Message"
                  name="message"
                  required
                  rows={6}
                  autoResize={true}
                />
              </div>
            </div>
          </CardContent>

          <CardFooter client:load className="flex-col gap-2">
            <Button
              client:load
              type="submit"
              data-contact-submit
              className="w-full"
              aria-busy="false"
            >
              <svg
                data-contact-spinner
                class="hidden w-4 h-4 mr-2 animate-spin"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                  fill="none"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              <span data-contact-text>Send</span>
            </Button>

            {
              error && (
                <div
                  class="mt-2 w-full text-sm p-2 bg-red-100 border border-red-300 text-red-700 rounded-md text-center"
                  role="alert"
                  aria-live="assertive"
                >
                  <p class="font-semibold">{decodeURIComponent(error)}</p>
                </div>
              )
            }
          </CardFooter>
        </Card>
      </form>

      <div class="w-full max-w-lg hidden" data-contact-success>
        <Card client:load className="p-6">
          <div class="flex items-start gap-3 pt-1">
            <CheckCircle2Icon client:load className="size-5" />
            <div class="flex flex-col">
              <CardTitle
                client:load
                className="text-lg font-semibold leading-none mb-2"
                >Message Sent</CardTitle
              >
              <CardDescription client:load className="leading-relaxed">
                <p>Thanks for getting in touch.</p> <p>We'll get back to you as soon as we
                can.</p>
              </AlertDescription>
            </div>
          </div>
        </Card>
      </div>
    </div>
  </div>
</Layout>

<script>
  const form = document.querySelector("[data-contact-form]") as HTMLFormElement;
  const submitButton = document.querySelector(
    "[data-contact-submit]"
  ) as HTMLButtonElement;
  const buttonText = document.querySelector(
    "[data-contact-text]"
  ) as HTMLSpanElement;
  const loadingSpinner = document.querySelector(
    "[data-contact-spinner]"
  ) as HTMLElement;
  const successContainer = document.querySelector(
    "[data-contact-success]"
  ) as HTMLElement;

  form.addEventListener("submit", async (event: SubmitEvent) => {
    // console.log("Form submit event triggered");
    event.preventDefault();

    // Set loading state
    submitButton.disabled = true;
    submitButton.setAttribute("aria-busy", "true");
    buttonText.textContent = "Sending...";
    loadingSpinner.classList.remove("hidden");

    try {
      const response = await fetch("/api/contact", {
        method: "POST",
        body: new FormData(event.target as HTMLFormElement),
      });

      const data = await response.json();

      if (!response.ok) {
        // Reset loading state only for errors
        submitButton.disabled = false;
        submitButton.setAttribute("aria-busy", "false");
        buttonText.textContent = "Send";
        loadingSpinner.classList.add("hidden");

        window.location.href = `/contact?error=${encodeURIComponent(data.error)}`;
      } else {
        document.querySelector("[data-contact-title]")?.classList.add("hidden");
        form.classList.add("hidden");
        successContainer.classList.remove("hidden");
        successContainer.setAttribute("tabindex", "-1");
        successContainer.focus();
      }
    } catch (error: any) {
      console.error("Error during contact request:", error);
      // Reset loading state for unexpected errors
      submitButton.disabled = false;
      submitButton.setAttribute("aria-busy", "false");
      buttonText.textContent = "Send";
      loadingSpinner.classList.add("hidden");

      window.location.href = `/contact?error=${encodeURIComponent("An unexpected error occurred")}`;
    }
  });
</script>
